#
# DeltaMaker 2T config file for Einsy Rambo board.
#
# Features:
# 1. extruder fan
# 2. power controlled touch probe
# 3. mesh bed leveling using touch probe

[gcode_macro BED_LEVEL]
variable_active: 0
variable_advanced: 0
variable_z_drop: -5.0
gcode:
  M118 active={active}
  M118 advanced={advanced}

[gcode_macro M117]
gcode:
  M118 someone typed M117

[gcode_macro AUTO_BED_MAPPING]
gcode:
  {% if printer["gcode_macro BED_LEVEL"].active == 0 %}
     SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=active VALUE=1
     BED_MESH_CLEAR
     G28
     BED_MESH_CALIBRATE
     G1 X0 Y0 F5000
  {% endif %}
[gcode_macro MOVE_NOZZLE_TO_BED]
variable_printing: 0
gcode:
   SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=active VALUE=0
   G28
   G1 Z20 F6000
   G1 X0 Y0
   G1 Z0 F600
[gcode_macro TOO_LOW]
default_parameter_STEP: 0.05
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced == 0 %}
    SET_GCODE_OFFSET Z_ADJUST=1.00 MOVE=1
    SET_GCODE_OFFSET Z_ADJUST={STEP} MOVE=1
    SET_GCODE_OFFSET Z_ADJUST=-1.00 MOVE=1
  {% else %}
    TESTZ Z={STEP}
  {% endif %}
[gcode_macro TOO_HIGH]
default_parameter_STEP: 0.05
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced == 0 %}
    SET_GCODE_OFFSET Z_ADJUST=1.00 MOVE=1
    SET_GCODE_OFFSET Z_ADJUST=-{STEP} MOVE=1
    SET_GCODE_OFFSET Z_ADJUST=-1.00 MOVE=1
  {% else %}
    TESTZ Z=-{STEP}
  {% endif %}
[gcode_macro SAVE_AND_HOME]
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced != 0 %} 
     ACCEPT
     SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=advanced VALUE=0
  {% endif %}
   SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=active VALUE=0
   G28
   SAVE_GCODE_OFFSET HOME=1
   SAVE_CONFIG

[gcode_macro START_PROBE_CALIBRATION]
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced == 0 %} 
     SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=advanced VALUE=1
     G28
     SET_GCODE_OFFSET Z=0.0
     BED_MESH_PROBE_CALIBRATE
     TESTZ Z={printer["gcode_macro BED_LEVEL"].z_drop}
  {% endif %}
[gcode_macro ACCEPT_POINT]
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced != 0 %} 
     ACCEPT
     TESTZ Z={printer["gcode_macro BED_LEVEL"].z_drop}
  {% endif %}

[gcode_macro ABORT_CALIBRATE]
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced != 0 %} 
     ABORT
     SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=advanced VALUE=0
  {% endif %}
  G91
  G1 Z10
  G90
  G1 X0 Y0 F5000

[gcode_macro SAVE_PROBE_CALIBRATE]
gcode:
  {% if printer["gcode_macro BED_LEVEL"].advanced != 0 %} 
     SET_GCODE_VARIABLE MACRO=BED_LEVEL VARIABLE=advanced VALUE=0
     SAVE_AND_HOME
  {% endif %}


# Enable the SAVE_GCODE_OFFSET command
[save_gcode_offset]
#
##### Trinket M0 auxboard
#
[mcu auxboard]
serial: /dev/serial/by-id/usb-Klipper_samd21e18a_B48A412A39365051202020352D0B18FF-if00
baud: 250000

[output_pin my_led]
pin: auxboard:PA10
value: 0
shutdown_value: 0

[gcode_macro blink_led]
gcode:
  SET_PIN PIN=my_led VALUE=1
  G4 P1000
  SET_PIN PIN=my_led VALUE=0

# Dotstar (aka APA102) LED support
[dotstar lights]
data_pin: auxboard:PA6
clock_pin: auxboard:PA7
chain_count: 6
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0
[dotstar trinket_dotstar]
data_pin: auxboard:PA0
clock_pin: auxboard:PA1
chain_count: 1

[gcode_macro set_led_color_temperature]
variable_temp: 0
gcode:
  SET_GCODE_VARIABLE MACRO=set_led_color_temperature VARIABLE=temp VALUE={printer.extruder.temperature}
  #M118 temp={temp}
  {% if temp < 1 %}
      SET_LED LED=lights RED=0.0 GREEN=0.0 BLUE=0.0
  {% elif temp < 40 %}
      # fade blue from 0.0 to 0.1
      SET_LED LED=lights RED=0.0 GREEN=0.0 BLUE={temp*0.0025}
  {% elif temp < 60 %}
      # between 40 and 60 degrees
      # fade blue from 0.1 to 0.0
      # fade red from 0.0 to 0.1
      SET_LED LED=lights RED={(temp-40)*0.005} GREEN=0.0 BLUE={(60-temp)*0.005}
  {% elif temp < 150 %}
      #between 60 and 150
      # fade red from 0.1 to 0.25
      SET_LED LED=lights RED={temp*0.0016} GREEN=0.0 BLUE=0.0
  {% else %}
      # above 150, fade in a little green
      SET_LED LED=lights RED=0.25 GREEN={temp*0.0001} BLUE=0.0
  {% endif %}

[delayed_gcode update_color_for_temperature]
initial_duration: 1
gcode:
  set_led_color_temperature
  UPDATE_DELAYED_GCODE ID=update_color_for_temperature DURATION=1

[gcode_macro color_temperature_off]
gcode:
  UPDATE_DELAYED_GCODE ID=update_color_for_temperature DURATION=0
  SET_LED LED=lights RED=0 GREEN=0 BLUE=0
#######


[mcu itsyboard]
serial: /dev/serial/by-id/usb-Klipper_samd21g18a_2EB3B1E33252525020312E30230703FF-if00
baud: 250000

[dotstar itsy_dotstar]
data_pin: itsyboard:PA1
clock_pin: itsyboard:PA0
chain_count: 1
initial_RED: 0.30
initial_GREEN: 0.20
initial_BLUE: 0.0

#
##### Smart-E toolbar
#
#[mcu toolboard]
#serial: /dev/serial/by-id/usb-Klipper_atmega32u4_12345-if00
#baud: 250000

# Print cooling fan (omit section if fan not present).
#[fan]
#pin: toolboard:PD6


#[temperature_sensor therm0]
#sensor_type: ATC Semitec 104GT-2
#sensor_pin: toolboard:PF0
#min_temp:
#max_temp:
#gcode_id: Therm0
##[temperature_sensor therm1]
##sensor_type: ATC Semitec 104GT-2
##sensor_pin: toolboard:PF1
#min_temp:
#max_temp:
##gcode_id: Therm1

##[temperature_fan my_temp_fan]
##pin: toolboard:PD7
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
##sensor_type: ATC Semitec 104GT-2
##sensor_pin: toolboard:PF0
##min_temp: -100
##max_temp: 100
##target_temp: 30.0
#   A temperature (in Celsius) that will be the target temperature.
#   The default is 40 degrees.
##max_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when the sensor temperature exceeds the set value.
#   The default is 1.0.
##min_speed: 0.1
#   The minimum fan speed (expressed as a value from 0.0 to 1.0) that
#   the fan will be set to for PID temperature fans.
#   The default is 0.3.
##control: pid
#   Control algorithm (either watermark or pid). This parameter must
#   be provided.
##pid_Kp: 40
#   Kp is the "proportional" constant for the pid. This parameter must
#   be provided for PID temperature fans.
##pid_Ki: 0.2
#   Ki is the "integral" constant for the pid. This parameter must be
#   provided for PID temperature fans.
##pid_Kd: 0.1
#   Kd is the "derivative" constant for the pid. This parameter must
#   be provided for PID temperature fans.
#pid_deriv_time: 2.0
#   A time value (in seconds) over which the derivative in the pid
#   will be smoothed to reduce the impact of measurement noise. The
#   default is 2 seconds.
#pid_integral_max:
#   The maximum "windup" the integral term may accumulate. The default
#   is to use the same value as max_power.
##gcode_id: Therm0
#   If set, the temperature will be reported in M105 queries using the
#   given id. The default is to not report the temperature via M105.

#############

# Enable the SAVE_GCODE_OFFSET command
[save_gcode_offset]

# Servos (one may define any number of sections with a "servo"
# prefix). The servos may be controlled using the SET_SERVO g-code
# command. For example: SET_SERVO SERVO=my_servo ANGLE=180
[servo extruder_select]
# T0: extruder_select angle=180
# T1: extruder_select angle=30
pin: ar5
#pin: ar10
#maximum_servo_angle: 180
#minimum_pulse_width: 0.001
#maximum_pulse_width: 0.002
initial_angle: 70
#initial_pulse_width: 0.0015
enable: True
#   Enable or disable servo. It can be enabled or disabled later using
#   SET_SERVO SERVO=my_servo ENABLE=<0|1> g-command.
#   The default is True (=enabled)

[output_pin probe_pwr_pin]
pin: PH5
value: 0
shutdown_value: 0

[gcode_macro PROBE_POWER_ON]
gcode:
   SET_PIN PIN=probe_pwr_pin VALUE=1
   G4 P500
[gcode_macro PROBE_POWER_OFF]
gcode:
   SET_PIN PIN=probe_pwr_pin VALUE=0

[probe]
pin: PE6
#x_offset: -16.0
#y_offset: -22.0
#z_offset: -0.2
speed: 10.0
#speed: 5
#samples: 2
#sample_retract_dist: 2.0
#samples_result: average
#samples_tolerance: 0.100
#samples_tolerance_retries: 0
activate_gcode:
    PROBE_POWER_ON
deactivate_gcode:
    PROBE_POWER_OFF


# Mesh Bed Leveling. One may define a [bed_mesh] config section
# to enable move transformations that offset the z axis based
# on a mesh generated from probed points.
[bed_mesh]
speed: 250
horizontal_move_z: 5
mesh_radius: 100
#round_probe_count: 7
#relative_reference_index: 14
round_probe_count: 5
relative_reference_index: 6
#round_probe_count: 3
#relative_reference_index: 2

#mesh_origin: -8, -11
fade_start: 1.0
fade_end: 10.0
split_delta_z: .025
#   The amount of Z difference (in mm) along a move that will
#   trigger a split. Default is .025.
move_check_distance: 5.0
#   The distance (in mm) along a move to check for split_delta_z.
#   This is also the minimum length that a move can be split. Default
#   is 5.0.
mesh_pps: 2,2
#   A comma separated pair of integers (X,Y) defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed
#   point. The user may enter a single value which will be applied
#   to both axes.  Default is 2,2.
algorithm: bicubic
#   The interpolation algorithm to use. May be either "lagrange"
#   or "bicubic". This option will not affect 3x3 grids, which
#   are forced to use lagrange sampling.  Default is lagrange.
#bicubic_tension: .2
#   When using the bicubic algorithm the tension parameter above
#   may be applied to change the amount of slope interpolated.
#   Larger numbers will increase the amount of slope, which
#   results in more curvature in the mesh. Default is .2.


[mcu]
#serial: /dev/ttyACM0
serial: /dev/serial/by-id/usb-UltiMachine__ultimachine.com__RAMBo_755353135303511111B1-if00
baud: 250000
pin_map: arduino


[printer]
kinematics: delta
max_velocity: 400
#max_accel: 2000
max_accel: 2500
minimum_z_position=-20
#delta_radius: 120.0
#   Radius (in mm) of the horizontal circle formed by the three linear
#   axis towers. This parameter may also be calculated as:
#    delta_radius = smooth_rod_offset - effector_offset - carriage_offset
#   This parameter must be provided.


# The stepper_a section describes the stepper controlling the front
# left tower (at 210 degrees). This section also controls the homing
# parameters (homing_speed, homing_retract_dist) for all towers.
[stepper_a]
step_pin: PC0
dir_pin: PL0
enable_pin: !PA7
step_distance: .01250
#step_distance: .00625
endstop_pin: ^PB6
#endstop_pin: tmc2130_stepper_a:virtual_endstop
homing_speed: 60
homing_retract_dist: 4
#position_endstop: 480
#arm_length: 265
#angle:

[tmc2130 stepper_a]
cs_pin: PG0
microsteps: 16
#microsteps: 32
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK2
driver_SGT: 3

# The stepper_b section describes the stepper controlling the front
# right tower (at 330 degrees).
[stepper_b]
step_pin: PC1
dir_pin: PL1
enable_pin: !PA6
step_distance: .01250
#step_distance: .00625
endstop_pin: ^PB5
#endstop_pin: tmc2130_stepper_b:virtual_endstop

[tmc2130 stepper_b]
cs_pin: PG2
microsteps: 16
#microsteps: 32
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK7
driver_SGT: 3

# The stepper_c section describes the stepper controlling the rear
# tower (at 90 degrees).
[stepper_c]
step_pin: PC2
dir_pin: PL2
enable_pin: !PA5
step_distance: .01250
#step_distance: .00625
endstop_pin: ^PF2
#endstop_pin: tmc2130_stepper_c:virtual_endstop

[tmc2130 stepper_c]
cs_pin: PK5
microsteps: 16
#microsteps: 32
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK6
driver_SGT: 3


[extruder]
step_pin: PC3
dir_pin: !PL6
enable_pin: !PA4
# DeltaMaker extruder
step_distance: .01036725
# Bondtech with 3:1 gear
#step_distance: .00246177
nozzle_diameter: 0.5
filament_diameter: 1.750
#pressure_advance: 0.5
#pressure_advance: 0.2
#heater_pin: auxboard:PE5
heater_pin: PE5
sensor_type: ATC Semitec 104GT-2
#sensor_pin: auxboard:PF0
sensor_pin: PF0
control: pid
pid_Kp: 22.45
pid_Ki: 2.90
pid_Kd: 43.41
##min_temp: 10
#NO HOTEND
min_temp: -100
min_extrude_temp: 170
max_temp: 260

[tmc2130 extruder]
cs_pin: PK4
microsteps: 16
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK3

[filament_switch_sensor filament_sensor]
switch_pin: PF1

[verify_heater extruder]
#NO HOTEND
# disable verify_heater by specifying a large hysteresis value
#hysteresis: 500


[heater_bed]
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
#sensor_type: NTC 100K beta 3950
#sensor_pin: PF2
sensor_pin: PF3
control: watermark
#min_temp: 10
min_temp: -100
max_temp: 130


# Print cooling fan (omit section if fan not present).
#[fan]
#pin: auxboard:PA10
# Trinket M0 red led

[heater_fan extruder_fan]
#pin: auxboard:PG5
pin: PG5
#heater: extruder
#heater_temp: 50.0
#fan_speed: 1.0

# Idle timeout. An idle timeout is automatically enabled - add an
# explicit idle_timeout config section to change the default settings.
[idle_timeout]
#gcode:
#   A list of G-Code commands (one per line; subsequent lines
#   indented) to execute on an idle timeout. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 900
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

# Enable the "M118" and "RESPOND" extended commands.
[respond]
default_type: echo
#    Sets the default prefix of the "M118" and "RESPOND" output to one of
#    the following:
#        echo: "echo: " (This is the default)
#        command: "// "
#        error: "!! "
# default_prefix: echo:
#    Directly sets the default prefix. If present, this value will override
#    the "default_type".

# Pause/Resume functionality with support of position capture and restore
[pause_resume]
#recover_velocity: 50.

# The delta_calibrate section enables a DELTA_CALIBRATE extended
# g-code command that can calibrate the tower endstop positions and
# angles.
[delta_calibrate]
radius: 100
#   Radius (in mm) of the area that may be probed. This is the radius
#   of nozzle coordinates to be probed; if using an automatic probe
#   with an XY offset then choose a radius small enough so that the
#   probe always fits over the bed. This parameter must be provided.
#speed: 50
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 20
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
#samples: 2
#   The number of times to probe each point.  The probed z-values will
#   be averaged. The default is to probe 1 time.
#sample_retract_dist: 2.0
#   The distance (in mm) to retract between each sample if sampling

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.0
#*#
#*# [save_gcode_offset]
#*# gcode_offset = 0.000, 0.000, 0.350
#*#
#*# [printer]
#*# delta_radius = 109.448957
#*#
#*# [stepper_a]
#*# angle = 210.523457
#*# arm_length = 267.679758
#*# position_endstop = 476.754730
#*#
#*# [stepper_b]
#*# angle = 330.055831
#*# arm_length = 263.384021
#*# position_endstop = 478.561769
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 266.110283
#*# position_endstop = 476.968719
#*#
#*# [probe_location_bias]
#*# offsets = 1.404, 1.236, 1.227, 1.448, 1.077, 0.0
#*#
#*# [delta_calibrate]
#*# height0 = 0.0
#*# height0_pos = 38175.000,38310.000,38095.000
#*# height1 = 0.0
#*# height1_pos = 41768.000,41973.000,36300.000
#*# height2 = 0.0
#*# height2_pos = 37938.000,43736.000,37826.000
#*# height3 = 0.0
#*# height3_pos = 36366.000,41268.000,40996.000
#*# height4 = 0.0
#*# height4_pos = 37680.000,37812.000,41717.000
#*# height5 = 0.0
#*# height5_pos = 40567.000,36572.000,40502.000
#*# height6 = 0.0
#*# height6_pos = 42614.000,37949.000,37723.000
#*# distance0 = 65.71
#*# distance0_pos1 = 38560.989,38873.978,38722.222
#*# distance0_pos2 = 37038.525,40930.479,40845.683
#*# distance1 = 66.86
#*# distance1_pos1 = 38645.269,38708.241,38805.681
#*# distance1_pos2 = 38279.713,38259.264,42359.283
#*# distance2 = 66.34
#*# distance2_pos1 = 38811.109,38629.917,38722.222
#*# distance2_pos2 = 40965.844,37108.130,40845.683
#*# distance3 = 65.99
#*# distance3_pos1 = 38892.644,38716.304,38556.384
#*# distance3_pos2 = 42445.981,38381.328,38163.850
#*# distance4 = 66.32
#*# distance4_pos1 = 38807.277,38882.111,38473.996
#*# distance4_pos2 = 40899.287,41071.739,36951.339
#*# distance5 = 65.88
#*# distance5_pos1 = 38641.470,38961.470,38556.384
#*# distance5_pos2 = 38222.204,42513.876,38163.850
#*# distance6 = 66.41
#*# distance6_pos1 = 37135.091,40496.801,40681.739
#*# distance6_pos2 = 38394.597,38135.647,42197.090
#*# distance7 = 66.23
#*# distance7_pos1 = 38378.647,38125.691,41877.632
#*# distance7_pos2 = 41002.533,37143.390,40605.165
#*# distance8 = 66.25
#*# distance8_pos1 = 40797.307,37206.607,40405.674
#*# distance8_pos2 = 42281.460,38496.353,38035.898
#*# distance9 = 66.21
#*# distance9_pos1 = 41962.071,38478.244,38022.022
#*# distance9_pos2 = 40659.249,41106.045,36982.899
#*# distance10 = 65.44
#*# distance10_pos1 = 40462.238,40898.030,37046.162
#*# distance10_pos2 = 38096.291,42346.771,38278.578
#*# distance11 = 66.26
#*# distance11_pos1 = 38084.272,42027.515,38264.530
#*# distance11_pos2 = 37071.835,40691.019,40884.468
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.109406, 0.109406, 0.109406, 0.109406, 0.109406
#*# 	  0.075553, 0.075553, 0.028831, -0.061539, -0.061539
#*# 	  -0.024735, -0.027026, 0.000000, -0.012228, 0.121850
#*# 	  0.091468, 0.091468, -0.096766, -0.184820, -0.184820
#*# 	  -0.291409, -0.291409, -0.291409, -0.291409, -0.291409
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -99.9968506086
#*# max_x = 99.9980052633
#*# min_y = -99.998362706
#*# max_y = 99.9926952758
