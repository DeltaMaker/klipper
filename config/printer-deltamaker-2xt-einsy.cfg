#
# DeltaMaker 2XT config file for Einsy Rambo board.
#
# Features:
# 1. extruder fan
# 2. power controlled touch probe
# 3. mesh bed leveling using touch probe
#
[gcode_macro MOVE1]
gcode:
   DOCK1
   PARK
   G4 P500
   DROP
  
[gcode_macro DROP]
gcode:
   G91
   G1 Z-60 F20000
   G90
[gcode_macro LIFT]
gcode:
   SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=1000
   G91
   G1 Z45 F20000
   G90
[gcode_macro CENTER]
gcode:
   G90
   G1 X0 Y-20 F20000
  
[gcode_macro DOCK1]
gcode:
   SET_VELOCITY_LIMIT VELOCITY=500 ACCEL=1000 ACCEL_TO_DECEL=1000
   G90
   G1 X0 Y0 F5000
   G28
   ;G1 Z301.4 F10000
   G1 Z300.5 F20000
   ;G1 X44.8 Y20.6 F20000
   G1 X46.8 Y24.6

[gcode_macro PICK1]
gcode:
   SET_VELOCITY_LIMIT VELOCITY=500 ACCEL=1000 ACCEL_TO_DECEL=1000
   G90
   G1 X-100 Y-50 F5000
   G28
   G1 X-100 Y0 Z250 F10000
   ;G1 X75.3 Y23.5
   G1 x71.8 y26.6

   G1 Z280 F500

[gcode_macro PARK]
gcode:
   SET_VELOCITY_LIMIT VELOCITY=500 ACCEL=5000
   G91
   ;G1 X25 Y8 F10000
   ;G1 X8 Y-8
   G1 X24 Y3 F10000
   G1 X3 Y3 Z-3
   G1 X2 Y-6 Z-2
   G1 Z-5
   G90
[gcode_macro UNPARK]
gcode:
   SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=1000
   G91
   ;G1 X-8 Y8
   ;G1 X-25 Y-8 F10000
   G1 X-3 Y-3 Z1
   G1 X-24 Y-3 F10000
   G90



# Include gcode_macros that provide DeltaMaker specific commands
[include printer-deltamaker-gcode-macros.cfg]

# Enable the SAVE_GCODE_OFFSET command
[save_gcode_offset]

# Servos (one may define any number of sections with a "servo"
# prefix). The servos may be controlled using the SET_SERVO g-code
# command. For example: SET_SERVO SERVO=my_servo ANGLE=180
[servo extruder_select]
# T0: extruder_select angle=180
# T1: extruder_select angle=30
pin: ar5
#pin: ar10
#maximum_servo_angle: 180
#minimum_pulse_width: 0.001
#maximum_pulse_width: 0.002
initial_angle: 70
#initial_pulse_width: 0.0015
enable: True
#   Enable or disable servo. It can be enabled or disabled later using
#   SET_SERVO SERVO=my_servo ENABLE=<0|1> g-command.
#   The default is True (=enabled)

[output_pin probe_pwr_pin]
pin: PH5
value: 0
shutdown_value: 0

[gcode_macro PROBE_POWER_ON]
gcode:
   SET_PIN PIN=probe_pwr_pin VALUE=1
   G4 P500
[gcode_macro PROBE_POWER_OFF]
gcode:
   SET_PIN PIN=probe_pwr_pin VALUE=0

[probe]
pin: PE6
#x_offset: -16.0
#y_offset: -22.0
z_offset: -0.2
speed: 10.0
#speed: 5
#samples: 2
#sample_retract_dist: 2.0
#samples_result: average
#samples_tolerance: 0.100
#samples_tolerance_retries: 0
activate_gcode:
    PROBE_POWER_ON
deactivate_gcode:
    PROBE_POWER_OFF


# Mesh Bed Leveling. One may define a [bed_mesh] config section
# to enable move transformations that offset the z axis based
# on a mesh generated from probed points.
[bed_mesh]
speed: 250
horizontal_move_z: 5
mesh_radius: 100
#round_probe_count: 7
#relative_reference_index: 14
round_probe_count: 5
relative_reference_index: 6
#round_probe_count: 3
#relative_reference_index: 2
#mesh_origin: -8, -11
fade_start: 1.0
fade_end: 10.0
split_delta_z: .025
#   The amount of Z difference (in mm) along a move that will
#   trigger a split. Default is .025.
move_check_distance: 5.0
#   The distance (in mm) along a move to check for split_delta_z.
#   This is also the minimum length that a move can be split. Default
#   is 5.0.
mesh_pps: 2,2
#   A comma separated pair of integers (X,Y) defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed
#   point. The user may enter a single value which will be applied
#   to both axes.  Default is 2,2.
algorithm: bicubic
#   The interpolation algorithm to use. May be either "lagrange"
#   or "bicubic". This option will not affect 3x3 grids, which
#   are forced to use lagrange sampling.  Default is lagrange.
#bicubic_tension: .2
#   When using the bicubic algorithm the tension parameter above
#   may be applied to change the amount of slope interpolated.
#   Larger numbers will increase the amount of slope, which
#   results in more curvature in the mesh. Default is .2.

[mcu]
serial: /dev/ttyACM0
#serial: /dev/serial/by-id/usb-UltiMachine__ultimachine.com__RAMBo_755353135303511111B1-if00
baud: 250000
pin_map: arduino

[printer]
kinematics: delta
max_velocity: 400
#max_accel: 2000
max_accel: 2500
minimum_z_position=-10
#delta_radius: 120.0
#   Radius (in mm) of the horizontal circle formed by the three linear
#   axis towers. This parameter may also be calculated as:
#    delta_radius = smooth_rod_offset - effector_offset - carriage_offset
#   This parameter must be provided.

[endstop_phase]

# The stepper_a section describes the stepper controlling the front
# left tower (at 210 degrees). This section also controls the homing
# parameters (homing_speed, homing_retract_dist) for all towers.
[stepper_a]
step_pin: PC0
dir_pin: PL0
enable_pin: !PA7
step_distance: .01250
#step_distance: .00625
endstop_pin: ^PB6
#endstop_pin: tmc2130_stepper_a:virtual_endstop
homing_speed: 60
homing_retract_dist: 4
#position_endstop: 580
#arm_length: 265
#angle:

[tmc2130 stepper_a]
cs_pin: PG0
microsteps: 16
#microsteps: 32
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK2
driver_SGT: 3

# The stepper_b section describes the stepper controlling the front
# right tower (at 330 degrees).
[stepper_b]
step_pin: PC1
dir_pin: PL1
enable_pin: !PA6
step_distance: .01250
#step_distance: .00625
endstop_pin: ^PB5
#endstop_pin: tmc2130_stepper_b:virtual_endstop

[tmc2130 stepper_b]
cs_pin: PG2
microsteps: 16
#microsteps: 32
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK7
driver_SGT: 3

# The stepper_c section describes the stepper controlling the rear
# tower (at 90 degrees).
[stepper_c]
step_pin: PC2
dir_pin: PL2
enable_pin: !PA5
step_distance: .01250
#step_distance: .00625
endstop_pin: ^PF2
#endstop_pin: tmc2130_stepper_c:virtual_endstop

[tmc2130 stepper_c]
cs_pin: PK5
microsteps: 16
#microsteps: 32
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK6
driver_SGT: 3


[extruder]
step_pin: PC3
dir_pin: !PL6
enable_pin: !PA4
# DeltaMaker extruder
step_distance: .01036725
# Bondtech with 3:1 gear
#step_distance: .00246177
nozzle_diameter: 0.5
filament_diameter: 1.750
#pressure_advance: 0.5
#pressure_advance: 0.2
#heater_pin: auxboard:PE5
heater_pin: PE5
sensor_type: ATC Semitec 104GT-2
#sensor_pin: auxboard:PF0
sensor_pin: PF0
control: pid
pid_Kp: 22.45
pid_Ki: 2.90
pid_Kd: 43.41
#min_temp: 10
#NO HOTEND
min_temp: -100
min_extrude_temp: -100

#min_extrude_temp: 170
max_temp: 260

[tmc2130 extruder]
cs_pin: PK4
microsteps: 16
run_current: .70
sense_resistor: 0.220
diag1_pin: !PK3

[filament_switch_sensor filament_sensor]
switch_pin: PF1

[verify_heater extruder]
#NO HOTEND
# disable verify_heater by specifying a large hysteresis value
#hysteresis: 500

[heater_bed]
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
#sensor_type: NTC 100K beta 3950
#sensor_pin: PF2
sensor_pin: PF3
control: watermark
#min_temp: 10
min_temp: -100
max_temp: 130


# Print cooling fan (omit section if fan not present).
#[fan]
#pin: auxboard:PA10
# 

[heater_fan extruder_fan]
#pin: auxboard:PG5
pin: PG5
#heater: extruder
#heater_temp: 50.0
#fan_speed: 1.0


# Idle timeout. An idle timeout is automatically enabled - add an
# explicit idle_timeout config section to change the default settings.
[idle_timeout]
#gcode:
#   A list of G-Code commands (one per line; subsequent lines
#   indented) to execute on an idle timeout. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 900
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

# Enable the "M118" and "RESPOND" extended commands.
[respond]
default_type: echo
#    Sets the default prefix of the "M118" and "RESPOND" output to one of
#    the following:
#        echo: "echo: " (This is the default)
#        command: "// "
#        error: "!! "
# default_prefix: echo:
#    Directly sets the default prefix. If present, this value will override
#    the "default_type".

# Pause/Resume functionality with support of position capture and restore
[pause_resume]
#recover_velocity: 50.

# The delta_calibrate section enables a DELTA_CALIBRATE extended
# g-code command that can calibrate the tower endstop positions and
# angles.
[delta_calibrate]
radius: 100
#   Radius (in mm) of the area that may be probed. This is the radius
#   of nozzle coordinates to be probed; if using an automatic probe
#   with an XY offset then choose a radius small enough so that the
#   probe always fits over the bed. This parameter must be provided.
#speed: 50
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 20
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
#samples: 2
#   The number of times to probe each point.  The probed z-values will
#   be averaged. The default is to probe 1 time.
#sample_retract_dist: 2.0
#   The distance (in mm) to retract between each sample if sampling

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*#
#*# [save_gcode_offset]
#*# gcode_offset = 0.000, 0.000, 0.050
#*#
#*# [old_probe_location_bias]
#*# offsets = 1.237, 1.163, 1.018, 1.168, 1.258, 0.649, 1.701, 1.149, 1.295, 1.002, 1.050, 1.145, 1.227
#*#
#*# [rri_probe_location_bias]
#*# offsets = 0.236, 0.099, 0.047, 0.105, 0.194, 0.048, 0.000, 1.299, 1.446, 1.202, 1.250, 1.395, 1.302
#*#
#*# [printer]
#*# delta_radius = 110.648541
#*#
#*# [stepper_a]
#*# angle = 210.510820
#*# arm_length = 268.002937
#*# position_endstop = 584.420032
#*#
#*# [stepper_b]
#*# angle = 329.860614
#*# arm_length = 268.456948
#*# position_endstop = 585.041321
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 268.954348
#*# position_endstop = 584.491539
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.760443, 0.760443, 0.760443, 0.760443, 0.760443
#*# 	  0.439652, 0.439652, 0.326175, 0.423897, 0.423897
#*# 	  0.739137, 0.361975, 0.000000, 0.014294, 0.083383
#*# 	  0.336864, 0.336864, -0.238266, -0.249535, -0.249535
#*# 	  -0.267548, -0.267548, -0.267548, -0.267548, -0.267548
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -100.003177298
#*# max_x = 100.000405739
#*# min_y = -99.9963501426
#*# max_y = 99.9981866723
#*#
#*# [delta_calibrate]
#*# height0 = -0.2
#*# height0_pos = 46787.000,46787.000,46787.000
#*# height1 = -0.2
#*# height1_pos = 50926.000,50926.000,44872.000
#*# height2 = -0.2
#*# height2_pos = 46609.000,53032.000,46609.000
#*# height3 = -0.2
#*# height3_pos = 44900.000,50238.000,50238.000
#*# height4 = -0.2
#*# height4_pos = 46368.000,46368.000,51075.000
#*# height5 = -0.2
#*# height5_pos = 49669.000,45015.000,49669.000
#*# height6 = -0.2
#*# height6_pos = 52022.000,46494.000,46494.000
#*# distance0 = 65.5066
#*# distance0_pos1 = 46590.161,46891.534,46843.495
#*# distance0_pos2 = 45090.578,48994.018,48949.725
#*# distance1 = 65.7606
#*# distance1_pos1 = 46669.836,46727.549,46926.016
#*# distance1_pos2 = 46263.538,46343.303,50443.331
#*# distance2 = 65.3796
#*# distance2_pos1 = 46833.795,46646.301,46843.495
#*# distance2_pos2 = 48910.373,45146.547,48949.725
#*# distance3 = 65.4812
#*# distance3_pos1 = 46918.118,46728.004,46679.507
#*# distance3_pos2 = 50435.195,46350.187,46298.474
#*# distance4 = 65.6336
#*# distance4_pos1 = 46837.413,46891.993,46598.032
#*# distance4_pos2 = 48973.137,49001.968,45098.275
#*# distance5 = 65.4812
#*# distance5_pos1 = 46673.423,46974.284,46679.507
#*# distance5_pos2 = 46317.878,50491.596,46298.474
#*# distance6 = 65.4304
#*# distance6_pos1 = 45181.541,48558.277,48786.310
#*# distance6_pos2 = 46376.451,46216.498,50282.851
#*# distance7 = 65.4812
#*# distance7_pos1 = 46363.451,46202.121,49966.694
#*# distance7_pos2 = 48950.124,45177.594,48711.680
#*# distance8 = 65.5828
#*# distance8_pos1 = 48751.274,45239.404,48513.634
#*# distance8_pos2 = 50276.929,46463.288,46171.425
#*# distance9 = 65.278
#*# distance9_pos1 = 49960.749,46448.282,46156.825
#*# distance9_pos2 = 48734.676,49039.514,45129.111
#*# distance10 = 65.2272
#*# distance10_pos1 = 48534.303,48838.006,45190.921
#*# distance10_pos2 = 46188.911,50330.837,46411.555
#*# distance11 = 65.659
#*# distance11_pos1 = 46172.536,50014.685,46396.777
#*# distance11_pos2 = 45119.748,48756.027,48987.520
#*#
#*# [probe_location_bias]
#*# offsets = 0.000, 0.000, 0.000, 0.000, 0.000
